{% load humanize %}

{{ recent_collections|json_script:"recent-collections" }}

<div class="fixed z-10 inset-0 overflow-y-auto" id="collection-picker-modal">
  <div class="fixed inset-0 transition-opacity" aria-hidden="true">
    <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
  </div>

  <div @click.away="modalOpen = false" class="flex items-center justify-center min-h-screen p-8">
    <div class="bg-white relative rounded-lg shadow-xl max-w-lg w-full" style="height: 600px; display: flex; flex-direction: column;" x-data="collectionPickerModal()">
      <div class="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
        <h2 class="text-xl font-semibold text-gray-900">Add to Collection</h2>
        <button @click="modalOpen = false" class="text-gray-400 hover:text-gray-500">
          <i class="ri-close-line text-2xl"></i>
        </button>
      </div>

      <div class="p-6 flex-1 overflow-y-auto">
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Search Collections</label>
          <input
            type="text"
            x-model="searchQuery"
            @input.debounce.300ms="searchCollections()"
            placeholder="Type to search..."
            class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500"
          />

          <div x-show="searchQuery.length >= 3 && searchResults.length > 0" class="mt-2 border border-gray-200 rounded-md max-h-48 overflow-y-auto">
            <template x-for="collection in searchResults" :key="collection.id">
              <button
                @click="selectCollection(collection.id)"
                class="w-full px-4 py-3 text-left hover:bg-gray-50 border-b border-gray-100 last:border-b-0 flex justify-between items-center"
              >
                <span x-text="collection.name" class="text-gray-900"></span>
              </button>
            </template>
          </div>

          <div x-show="searchQuery.length >= 3 && searchResults.length === 0 && !searching" class="mt-2 text-sm text-gray-500 text-center py-2">
            No collections found
          </div>
        </div>

        <div x-show="recentCollections.length > 0">
          <div class="text-center text-sm text-gray-500 mb-4">or choose from recent</div>

          <div class="space-y-2">
            <template x-for="collection in recentCollections" :key="collection.id">
              <button
                @click="selectCollection(collection.id)"
                class="w-full px-4 py-3 border border-gray-200 rounded-md hover:bg-gray-50 flex justify-between items-center text-left"
              >
                <span x-text="collection.name" class="text-gray-900"></span>
              </button>
            </template>
          </div>
        </div>

        <div x-show="errorMessage" x-text="errorMessage" class="mt-4 text-sm text-red-600"></div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
  function collectionPickerModal() {
    return {
      searchQuery: '',
      searchResults: [],
      searching: false,
      recentCollections: [],

      init() {
        this.recentCollections = JSON.parse(document.getElementById('recent-collections').textContent);
      },

      async searchCollections() {
        if (this.searchQuery.length < 3) {
          this.searchResults = [];
          return;
        }

        this.searching = true;
        try {
          const response = await axios.get("{% url 'api:collection_autocomplete' %}", {
            params: { query: this.searchQuery }
          });
          this.searchResults = response.data;
        } catch (error) {
          console.error('Search failed:', error);
        } finally {
          this.searching = false;
        }
      },

      selectCollection(collectionId) {
        window.dispatchEvent(new CustomEvent('collection-selected', {
          detail: { id: collectionId }
        }));
      }
    };
  }
</script>
