{% extends 'core/base.html' %}
{% load static %}

{% block content %}
  <div class="heading-1 mb-4">Edit Draft DOI for {{ draft_doi.collection.name }}<span class="ml-2 text-base font-semibold"><a
    href="{% url 'core/doi-detail' draft_doi.slug %}">back to draft DOI</a></span></div>

  <div x-data="DraftDoiEditForm()">
    {{ draft_doi.collection.description|json_script:"collection-description" }}
    <div x-init="description = JSON.parse(document.getElementById('collection-description').textContent)"></div>
    <form @submit.prevent="updateDraftDOI('{{ draft_doi.slug }}')">
      <div class="mb-6">
        <label for="description" class="block text-sm font-semibold mb-2">
          Description
        </label>
        <textarea
          id="description"
          x-model="description"
          required
          rows="10"
          class="w-full border border-gray-300 rounded px-3 py-2 text-sm"
          placeholder="Describe the collection..."></textarea>
        <p class="text-xs text-gray-600 mt-2">
          Note: This description will be saved to the collection and used in the DOI metadata.
          Modifying this field will update the collection's description.
        </p>
      </div>

      <div class="flex justify-end gap-3">
        <a href="{% url 'core/doi-detail' draft_doi.slug %}" class="btn btn-secondary">Cancel</a>
        <button type="submit" class="btn btn-primary" :disabled="isSubmitting">
          <span x-text="isSubmitting ? 'Saving...' : 'Save Changes'"></span>
        </button>
      </div>
    </form>
  </div>

  {{ csrf_token|cut:""|json_script:"csrf-token" }}

  <script type="text/javascript">
    function DraftDoiEditForm() {
      const csrfToken = JSON.parse(document.getElementById("csrf-token")?.textContent);

      return {
        description: "",
        isSubmitting: false,

        async updateDraftDOI(slug) {
          this.isSubmitting = true;

          try {
            const response = await fetch(`/api/v2/doi/${slug}/`, {
              method: "PATCH",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify({
                description: this.description,
              }),
            });

            if (response.ok) {
              window.location.href = `/doi/${slug}`;
            } else {
              const errorData = await response.json();
              let errorMessage = "Failed to update draft DOI";

              if (errorData.error) {
                errorMessage = errorData.error;
              } else if (errorData.detail) {
                errorMessage = errorData.detail[0]?.msg || errorMessage;
              }

              alert(errorMessage);
              this.isSubmitting = false;
            }
          } catch (error) {
            console.error("Error updating draft DOI:", error);
            alert("An error occurred while updating the draft DOI");
            this.isSubmitting = false;
          }
        }
      };
    }
  </script>
{% endblock %}
